jQuery(function(t){var e=moment().format("X"),n=moment(config.start_time).format("X"),o=moment(config.end_time).format("X");getLiveArticle(),getLoginForm(),getComment(),n>=e?(getLiveInfo(),t(".comment").hide(),t(".info-div").on("finish.countdown",function(){window.location.reload()}),t(".hide-countdown").on("finish.countdown",function(){appendLive()})):e>=o?(t(".info-div").hide(),t(".live-info .user-btn").hide(),appendLive()):(appendLive(),t(".info-div").hide(),t(".login-form").addClass("show"),-1!==t.inArray(t.cookie("live-uid"),config.moderator_uid)&&t("body").on("click",".chat",function(e){e.stopPropagation();var n=t(this).data("toggled");t(this).data("toggled",!n),n?(unmentionSomeone(t(this).attr("data-name")),t(this).removeClass("mention")):(mentionSomeone(t(this).attr("data-name")),t(this).addClass("mention"))}),t("body").on("keypress",".add-chat-input",function(e){return 13==e.which&&e.shiftKey!==!0?(t(".add-chat-btn").click(),!1):void 0}),t(".add-chat-input").textareaAutoSize().emojiPicker({width:"300px",height:"200px",button:!1}),t(".emoji-btn").click(function(e){e.preventDefault(),t(".add-chat-input").emojiPicker("toggle")}),t(".add-chat-btn").click(function(e){e.stopPropagation();var n=t.trim(t(".add-chat-input").val());""!==n&&(t(this).css("pointer-events","none"),t(".add-chat-input").prop("disabled",!0),appendComment({is_img:!1,uid:t.cookie("live-uid"),display_name:t(".logout .avatars").attr("data-name"),time:moment().format("X"),message:n},"client"),t(this).css("pointer-events","auto"),t(".add-chat-input").val("").prop("disabled",!1).attr("rows",1).css("height","auto"))}),t(".hide-countdown").countdown(config.end_time,function(e){t(".hide-countdown").text(e.strftime("%D-%H:%M:%S"))}),t(".hide-countdown").on("finish.countdown",function(){window.location.reload()})),t(window).load(function(){var t=window.location.search.substring(1);if(""!==t){var e=t?JSON.parse('{"'+window.location.search.substring(1).replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(t,e){return""===t?e:decodeURIComponent(e)}):{};e.hasOwnProperty("code")&&0!==e.code.length?ajax_login(e.code,"regular"):alert("取得 Facebook 授權失敗。")}}),t(".fb-login-btn").click(function(){t(this).html('<i class="fa fa-facebook"></i>登入中⋯⋯')}),t(".logout").click(function(){t(".logout").removeClass("show"),t(".logout .avatars").attr("src","images/avatars.png").removeAttr("data-name"),t(".login-form").addClass("show"),t.removeCookie("live-token"),t.removeCookie("live-fid"),t.removeCookie("live-uid");var e=parseInt(t(".user-btn .num").text(),10);t(".user-btn .num").text(e-1)}),e>=n&&o>=e&&setInterval(function(){updateComment()},6e4),t(".upload-btn").click(function(e){e.preventDefault(),e.stopImmediatePropagation(),t("#add-photo-file").click()}),t("#add-photo-file").on("change",function(e){e.preventDefault(),e.stopImmediatePropagation();var n=this.files[0]||!1;if(!n)return!1;if(n.size>8388608)return alert("檔案大小必須小於 8MB。"),!1;if(-1===n.type.indexOf("image"))return alert("您必須上傳圖片類型的檔案。"),!1;var o=function(){return alert("上傳照片失敗。"),!1},a=t(this);return a.val(""),t.get(config.api+"/uploadToken?title="+n.name,{},"json").done(function(e){if(!e)return o(),void 0;var a=new FormData;a.append("AWSAccessKeyId","AKIAIE3JKDD3NVIW67BA"),a.append("acl","public-read"),a.append("key",e.key),a.append("policy",e.policy),a.append("success_action_status","201"),a.append("signature",e.signature),a.append("Cache-Control","max-age=1209600"),a.append("Content-Type",e.contentType),a.append("file",n),t.ajax({url:"https://uploads-fanily-tw.s3.amazonaws.com",data:a,type:"POST",dataType:"xml",contentType:!1,processData:!1}).done(function(e){var n=e.getElementsByTagName("Location")[0].firstChild.nodeValue;n=n.replace(/%2F/g,"/"),appendComment({is_img:!0,uid:t.cookie("live-uid"),display_name:t(".logout .avatars").attr("data-name"),time:moment().format("X"),message:n},"client")}).fail(o)}).fail(o),!1})});