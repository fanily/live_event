jQuery(function(t){var e=function(){return function(e,a,n){var i=t(e).html();return"undefined"==typeof a?Mustache.render(i):"undefined"==typeof n?Mustache.render(i,a):Mustache.render(i,a,n)}}(),a=function(e){var a=e.match(/(\(.*?)?\b((?:https?|ftp|file):\/\/[-a-z0-9+&@#\/%?=~_()|!:,.;]*[-a-z0-9+&@#\/%=~_()|])/gi);return t.each(a,function(t,a){e=e.replace(a,'<a href="'+a+'" target="_target">'+a+"</a>")}),e},n=function(){t.ajax({type:"GET",url:"comment.json",dataType:"json"}).done(function(n){if(!t.isEmptyObject(n)){t(".live-info .comment-btn .num").text(n.length);var i=[];n.reverse(),t.each(n,function(t,e){var n=moment.utc(e.timestamp).local().format("X");""!==e.image?e.message='<img src="'+e.image+'">':(e.message.match(/(\(.*?)?\b((?:https?|ftp|file):\/\/[-a-z0-9+&@#\/%?=~_()|!:,.;]*[-a-z0-9+&@#\/%=~_()|])/gi)&&(e.message=a(e.message)),e.message=e.message.replace(/\n/g,"<br>")),i.push({avatars:"https://graph.facebook.com/"+e.uid+"/picture?width=50",display_name:e.display_name,comment:e.message,time:moment.unix(n).format("YYYY-MM-DD HH:mm"),unixtime:n})});var o=e("#template-comment-list",{list:i});t(".chat-list").append(o).animate({scrollTop:t(".chat-list").prop("scrollHeight")},1e3)}})},i=function(e){var a=t(".add-chat-input").val(),n=t(".add-chat-input").attr("data-name");if("undefined"==typeof n)t(".add-chat-input").attr("data-name",e),t(".add-chat-input").val("@"+e+" "+a);else{var i=n.split(" ");-1==t.inArray(e,i)&&(t(".add-chat-input").attr("data-name",n+" "+e),t(".add-chat-input").val("@"+e+" "+a))}},o=function(e){var a=t(".add-chat-input").attr("data-name").split(" ");if(-1!==t.inArray(e,a)){var n=t(".add-chat-input").val().replace("@"+e,"");a=t.grep(a,function(t){return t!=e}),t(".add-chat-input").attr("data-name",a.join(" ")),t(".add-chat-input").val(t.trim(n))}},r=function(t,e,a){var n=window.open(t,e),i=window.setInterval(function(){try{(null==n||n.closed)&&(window.clearInterval(i),a(n))}catch(t){}},1e3);return n};if(moment().format("X")<=moment(config.start_time).format("X")){t(".login-form").remove(),t(".comment").remove();var c=e("#template-info",{title:config.info.title,date:config.info.date,content:config.info.content,is_end:!1,fanily:config.info.social.fanily,facebook:config.info.social.facebook,twitter:config.info.social.twitter,google_plus:config.info.social.google_plus,weibo:config.info.social.weibo});t(".info-div").append(c).addClass("show").countdown(config.start_time,function(e){t(".countdown .date .count").text(e.strftime("%D")),t(".countdown .hour .count").text(e.strftime("%H")),t(".countdown .min .count").text(e.strftime("%M")),t(".countdown .sec .count").text(e.strftime("%S"))})}else moment().format("X")>=moment(config.end_time).format("X")?(t(".login-form").remove(),t(".info-div").remove()):(t(".info-div").remove(),t("body").on("keypress",".add-chat-input",function(e){return 13==e.which&&e.shiftKey!==!0?(t(".add-chat-btn").click(),!1):void 0}),-1!==t.inArray(t.cookie("live-uid"),config.moderator_uid)&&t("body").on("click",".chat",function(e){e.stopPropagation();var a=t(this).data("toggled");t(this).data("toggled",!a),a?(o(t(this).attr("data-name")),t(this).removeClass("mention")):(i(t(this).attr("data-name")),t(this).addClass("mention"))}),t(".add-chat-input").textareaAutoSize().emojiPicker({width:"300px",height:"200px",button:!1}),t(".emoji-btn").click(function(e){e.preventDefault(),t(".add-chat-input").emojiPicker("toggle")}),t(".add-chat-btn").click(function(n){n.stopPropagation();var i=t.trim(t(".add-chat-input").val());if(""!==i){t(this).css("pointer-events","none"),t(".add-chat-input").prop("disabled",!0);var o=parseInt(t(".comment-btn .num").text(),10);t(".comment-btn .num").text(o+1),m.emit("new message",{message:i}),i.match(/(\(.*?)?\b((?:https?|ftp|file):\/\/[-a-z0-9+&@#\/%?=~_()|!:,.;]*[-a-z0-9+&@#\/%=~_()|])/gi)&&(i=a(i));var r=e("#template-new-comment",{avatars:t(".logout .avatars").attr("src"),display_name:t(".logout .avatars").attr("data-name"),comment:i.replace(/\n/g,"<br>"),unixtime:moment().format("X")});if(-1!==t.inArray(t.cookie("live-uid"),config.moderator_uid)){var c=t(r).addClass("announce");0!==t(".comment .announce").length&&t(".comment .announce").remove(),t(".chat-list").before(c),t(".chat-list .mention").removeClass("mention")}t(".chat-list").append(r).animate({scrollTop:t(".chat-list").prop("scrollHeight")},1e3),t(this).css("pointer-events","auto"),t(".add-chat-input").val("").prop("disabled",!1).attr("rows",1).css("height","auto")}}));if(t(".live-title").find("h1").html(config.title),t(".live-title").find("h2").html(config.description),window.matchMedia("screen and (max-width: 480px)").matches&&(insert="《一把青》<br>全球首航特映會",t(".live-title h1").html(insert),t(".live-title h2").hide()),window.matchMedia("screen and (max-width: 990px)").matches&&t(".banner").hide(),moment().format("X")<=moment(config.start_time).format("X")){var s="https://www.youtube.com/embed/"+config.video.id+"?autoplay=1";""!==config.video.start_time&&(s+="&start="+config.video.start_time),""!==config.video.playlist&&(s+="&playlist="+config.video.playlist)}else{var s="https://www.youtube.com/embed/"+config.live.id+"?autoplay=1";""!==config.live.start_time&&(s+="&start="+config.live.start_time),""!==config.live.playlist&&(s+="&playlist="+config.live.playlist)}t(".video-container").find("iframe").attr("src",s),t(".banner").find("a").attr("href",config.banner.link),t(".banner").find("img").attr("src",config.banner.image),t("title").text(config.title),ga("create","UA-38227997-6","auto"),ga("create","UA-38227997-1","auto",{name:"atouchofgreenLive"}),ga("send","pageview"),ga("atouchofgreenLive.send","pageview");var m=io.connect(config.api_socket);n(),t(".fb-login-btn").click(function(e){e.stopPropagation(),r(config.api+"/auth/facebook","_blank",function(){setTimeout(function(){"undefined"==typeof t.cookie("live-token")&&alert("取得 Facebook 授權失敗。")},2e3)})}),t(".logout").click(function(){t(".logout").removeClass("show"),t(".logout .avatars").attr("src","images/avatars.png").removeAttr("data-name"),t(".login-form").addClass("show"),t.removeCookie("live-token"),t.removeCookie("live-fid"),t.removeCookie("live-uid");var e=parseInt(t(".user-btn .num").text(),10);t(".user-btn .num").text(e-1)}),t(".social-group li").click(function(e){e.preventDefault();var a=t(this),n=config.title,i=window.location.href;a.hasClass("fb")&&window.open("https://www.facebook.com/share.php?u="+encodeURI(i),"_blank"),a.hasClass("weibo")&&window.open("http://v.t.sina.com.cn/share/share.php?title="+n+"&url="+i,"_blank"),a.hasClass("twitter")&&window.open("https://twitter.com/share?url="+encodeURI(i)+"&text="+n,"_blank"),a.hasClass("google-plus")&&window.open("https://plus.google.com/share?url="+encodeURI(i),"_blank")}),window.addEventListener("message",function(e){if(e.origin===config.api){var a=e.data;t.ajax({type:"GET",url:config.api+"/profile?access_token="+a,dataType:"json"}).done(function(e){var n="https://graph.facebook.com/"+e.uid+"/picture?width=50";m.emit("add user",{provider:"FB",id:e.id,uid:e.uid,display_name:e.display_name}),moment().format("X")>=moment(config.start_time).format("X")&&moment().format("X")<=moment(config.end_time).format("X")&&t(".add-chat").addClass("show"),t(".login-form").removeClass("show"),t(".logout .avatars").attr("src",n).attr("data-name",e.display_name),t(".logout").addClass("show");var i=parseInt(t(".user-btn .num").text(),10);t(".user-btn .num").text(i+1),t.cookie("live-token",a,{expires:7}),t.cookie("live-fid",e.id,{expires:7}),t.cookie("live-uid",e.uid,{expires:7})}).fail(function(){alert("取得 Facebook 授權失敗。")})}},!1),t(".upload-btn").click(function(e){e.preventDefault(),e.stopImmediatePropagation(),t("#add-photo-file").click()}),t("#add-photo-file").on("change",function(a){a.preventDefault(),a.stopImmediatePropagation();var n=this.files[0]||!1;if(!n)return!1;if(n.size>8388608)return alert("檔案大小必須小於 8MB。"),!1;if(-1===n.type.indexOf("image"))return alert("您必須上傳圖片類型的檔案。"),!1;var i=function(){return alert("上傳照片失敗。"),!1},o=t(this);return o.val(""),t.get(config.api+"/uploadToken?title="+n.name,{},"json").done(function(a){if(!a)return i(),void 0;var o=new FormData;o.append("AWSAccessKeyId","AKIAIE3JKDD3NVIW67BA"),o.append("acl","public-read"),o.append("key",a.key),o.append("policy",a.policy),o.append("success_action_status","201"),o.append("signature",a.signature),o.append("Cache-Control","max-age=1209600"),o.append("Content-Type",a.contentType),o.append("file",n),t.ajax({url:"https://uploads-fanily-tw.s3.amazonaws.com",data:o,type:"POST",dataType:"xml",contentType:!1,processData:!1}).done(function(a){var n=a.getElementsByTagName("Location")[0].firstChild.nodeValue;n=n.replace(/%2F/g,"/");var i=parseInt(t(".comment-btn .num").text(),10);t(".comment-btn .num").text(i+1);var o=e("#template-new-comment",{avatars:t(".logout .avatars").attr("src"),display_name:t(".logout .avatars").attr("data-name"),comment:'<img src="'+n+'">',unixtime:moment().format("X")});if(m.emit("new message",{message:n,isImg:!0}),-1!==t.inArray(t.cookie("live-uid"),config.moderator_uid)){var r=t(o).addClass("announce");0!==t(".comment .announce").length&&t(".comment .announce").remove(),t(".chat-list").before(r),t(".chat-list .mention").removeClass("mention")}t(".chat-list").append(o).animate({scrollTop:t(".chat-list").prop("scrollHeight")},1e3)}).fail(i)}).fail(i),!1})});