jQuery(function(e){var t=function(){return function(t,a,n){var o=e(t).html();return"undefined"==typeof a?Mustache.render(o):"undefined"==typeof n?Mustache.render(o,a):Mustache.render(o,a,n)}}(),a=function(t){var a=t.match(/(\(.*?)?\b((?:https?|ftp|file):\/\/[-a-z0-9+&@#\/%?=~_()|!:,.;]*[-a-z0-9+&@#\/%=~_()|])/gi);return e.each(a,function(e,a){t=t.replace(a,'<a href="'+a+'" target="_target">'+a+"</a>")}),t},n=function(){e.ajax({type:"GET",url:"comment.json",dataType:"json"}).done(function(n){if(!e.isEmptyObject(n)){e(".live-info .comment-btn .num").text(n.length);var o=[];n.reverse(),e.each(n,function(e,t){var n=moment.utc(t.timestamp).local().format("X");""!==t.image?t.message='<img src="'+t.image+'">':(t.message.match(/(\(.*?)?\b((?:https?|ftp|file):\/\/[-a-z0-9+&@#\/%?=~_()|!:,.;]*[-a-z0-9+&@#\/%=~_()|])/gi)&&(t.message=a(t.message)),t.message=t.message.replace(/\n/g,"<br>")),o.push({avatars:"https://graph.facebook.com/"+t.uid+"/picture?width=50",display_name:t.display_name,comment:t.message,time:moment.unix(n).format("YYYY-MM-DD HH:mm"),unixtime:n})});var i=t("#template-comment-list",{list:o});e(".chat-list").append(i).animate({scrollTop:e(".chat-list").prop("scrollHeight")},1e3)}})},o=function(t){var a=e(".add-chat-input").val(),n=e(".add-chat-input").attr("data-name");if("undefined"==typeof n)e(".add-chat-input").attr("data-name",t),e(".add-chat-input").val("@"+t+" "+a);else{var o=n.split(" ");-1==e.inArray(t,o)&&(e(".add-chat-input").attr("data-name",n+" "+t),e(".add-chat-input").val("@"+t+" "+a))}},i=function(t){var a=e(".add-chat-input").attr("data-name").split(" ");if(-1!==e.inArray(t,a)){var n=e(".add-chat-input").val().replace("@"+t,"");a=e.grep(a,function(e){return e!=t}),e(".add-chat-input").attr("data-name",a.join(" ")),e(".add-chat-input").val(e.trim(n))}},s=function(e,t,a){var n=window.open(e,t),o=window.setInterval(function(){try{(null==n||n.closed)&&(window.clearInterval(o),a(n))}catch(e){}},1e3);return n};if("undefined"!=typeof e.cookie("live-token")){var r=e.cookie("live-token");e.ajax({type:"GET",url:config.api+"/profile?access_token="+r,dataType:"json"}).done(function(t){var a="https://graph.facebook.com/"+t.uid+"/picture?width=50";l.emit("add user",{provider:"FB",id:t.id,uid:t.uid,display_name:t.display_name}),e(".login-form").removeClass("show"),moment().format("X")>=moment(config.start_time).format("X")&&moment().format("X")<=moment(config.end_time).format("X")&&e(".add-chat").addClass("show"),e(".logout .avatars").attr("src",a).attr("data-name",t.display_name),e(".logout").addClass("show");var n=parseInt(e(".user-btn .num").text(),10);e(".user-btn .num").text(n+1),e.cookie("live-token",r,{expires:7}),e.cookie("live-fid",t.id,{expires:7}),e.cookie("live-uid",t.uid,{expires:7})}).fail(function(){e.removeCookie("live-token"),alert("取得 Facebook 授權失敗。")})}if(moment().format("X")<=moment(config.start_time).format("X")){e(".login-form").remove(),e(".comment").remove();var m=t("#template-info",{title:config.info.title,date:config.info.date,content:config.info.content,is_end:!1,fanily:config.info.social.fanily,facebook:config.info.social.facebook,twitter:config.info.social.twitter,google_plus:config.info.social.google_plus,weibo:config.info.social.weibo});e(".info-div").append(m).addClass("show").countdown(config.start_time,function(t){e(".countdown .date .count").text(t.strftime("%D")),e(".countdown .hour .count").text(t.strftime("%H")),e(".countdown .min .count").text(t.strftime("%M")),e(".countdown .sec .count").text(t.strftime("%S"))})}else moment().format("X")>=moment(config.end_time).format("X")?(e(".login-form").remove(),e(".info-div").remove()):(e(".info-div").remove(),e("body").on("keypress",".add-chat-input",function(t){return 13==t.which&&t.shiftKey!==!0?(e(".add-chat-btn").click(),!1):void 0}),-1!==e.inArray(e.cookie("live-uid"),config.moderator_uid)&&e("body").on("click",".chat",function(t){t.stopPropagation();var a=e(this).data("toggled");e(this).data("toggled",!a),a?(i(e(this).attr("data-name")),e(this).removeClass("mention")):(o(e(this).attr("data-name")),e(this).addClass("mention"))}),e(".add-chat-input").textareaAutoSize().emojiPicker({width:"300px",height:"200px",button:!1}),e(".emoji-btn").click(function(t){t.preventDefault(),e(".add-chat-input").emojiPicker("toggle")}),e(".add-chat-btn").click(function(n){n.stopPropagation();var o=e.trim(e(".add-chat-input").val());if(""!==o){e(this).css("pointer-events","none"),e(".add-chat-input").prop("disabled",!0);var i=parseInt(e(".comment-btn .num").text(),10);e(".comment-btn .num").text(i+1),l.emit("new message",{message:o}),o.match(/(\(.*?)?\b((?:https?|ftp|file):\/\/[-a-z0-9+&@#\/%?=~_()|!:,.;]*[-a-z0-9+&@#\/%=~_()|])/gi)&&(o=a(o));var s=t("#template-new-comment",{avatars:e(".logout .avatars").attr("src"),display_name:e(".logout .avatars").attr("data-name"),comment:o.replace(/\n/g,"<br>"),unixtime:moment().format("X")});if(-1!==e.inArray(e.cookie("live-uid"),config.moderator_uid)){var r=e(s).addClass("announce");0!==e(".comment .announce").length&&e(".comment .announce").remove(),e(".chat-list").before(r),e(".chat-list .mention").removeClass("mention")}e(".chat-list").append(s).animate({scrollTop:e(".chat-list").prop("scrollHeight")},1e3),e(this).css("pointer-events","auto"),e(".add-chat-input").val("").prop("disabled",!1).attr("rows",1).css("height","auto")}}));if(e(".live-title").find("h1").html(config.title),e(".live-title").find("h2").html(config.description),window.matchMedia("screen and (max-width: 480px)").matches&&(insert="《一把青》<br>全球首航特映會",e(".live-title h1").html(insert),e(".live-title h2").hide()),window.matchMedia("screen and (max-width: 990px)").matches&&e(".banner").hide(),moment().format("X")<=moment(config.start_time).format("X")){var c="https://www.youtube.com/embed/"+config.video.id+"?autoplay=1";""!==config.video.start_time&&(c+="&start="+config.video.start_time),""!==config.video.playlist&&(c+="&playlist="+config.video.playlist)}else{var c="https://www.youtube.com/embed/"+config.live.id+"?autoplay=1";""!==config.live.start_time&&(c+="&start="+config.live.start_time),""!==config.live.playlist&&(c+="&playlist="+config.live.playlist)}e(".video-container").find("iframe").attr("src",c),e(".banner").find("a").attr("href",config.banner.link),e(".banner").find("img").attr("src",config.banner.image),e("title").text(config.title),ga("create","UA-38227997-6","auto"),ga("create","UA-38227997-1","auto",{name:"atouchofgreenLive"}),ga("send","pageview"),ga("atouchofgreenLive.send","pageview");var l=io.connect(config.api_socket);l.emit("get numUsers"),n(),e(".fb-login-btn").click(function(t){t.stopPropagation(),s(config.api+"/auth/facebook","_blank",function(){setTimeout(function(){"undefined"==typeof e.cookie("live-token")&&alert("取得 Facebook 授權失敗。")},2e3)})}),e(".logout").click(function(){e(".logout").removeClass("show"),e(".logout .avatars").attr("src","images/avatars.png").removeAttr("data-name"),e(".login-form").addClass("show"),e.removeCookie("live-token"),e.removeCookie("live-fid"),e.removeCookie("live-uid"),l.emit("user left");var t=parseInt(e(".user-btn .num").text(),10);e(".user-btn .num").text(t-1)}),e(".social-group li").click(function(t){t.preventDefault();var a=e(this),n=config.title,o=window.location.href;a.hasClass("fb")&&window.open("https://www.facebook.com/share.php?u="+encodeURI(o),"_blank"),a.hasClass("weibo")&&window.open("http://v.t.sina.com.cn/share/share.php?title="+n+"&url="+o,"_blank"),a.hasClass("twitter")&&window.open("https://twitter.com/share?url="+encodeURI(o)+"&text="+n,"_blank"),a.hasClass("google-plus")&&window.open("https://plus.google.com/share?url="+encodeURI(o),"_blank")}),l.on("numUsers",function(t){0==t.numUsers&&"undefined"!=typeof e.cookie("live-token")?e(".live-info .user-btn .num").text(1):e(".live-info .user-btn .num").text(t.numUsers)}),l.on("new message",function(n){var o=parseInt(e(".comment-btn .num").text(),10);e(".comment-btn .num").text(o+1),1==n.message.isImg?n.message.message='<img src="'+n.message.message+'">':(n.message.message.match(/(\(.*?)?\b((?:https?|ftp|file):\/\/[-a-z0-9+&@#\/%?=~_()|!:,.;]*[-a-z0-9+&@#\/%=~_()|])/gi)&&(n.message.message=a(n.message.message)),n.message.message=n.message.message.replace(/\n/g,"<br>"));var i=t("#template-new-comment",{avatars:"https://graph.facebook.com/"+n.user.uid+"/picture?width=50",display_name:n.user.display_name,comment:n.message.message,unixtime:moment().format("X")});if(-1!==e.inArray(n.user.uid,config.moderator_uid)){var s=e(i).addClass("announce");0!==e(".comment .announce").length&&e(".comment .announce").remove(),e(".chat-list").before(s)}e(".chat-list").append(i).animate({scrollTop:e(".chat-list").prop("scrollHeight")},1e3)}),l.on("user joined",function(t){e(".live-info .user-btn .num").text(t.numUsers)}),l.on("user left",function(t){e(".live-info .user-btn .num").text(t.numUsers)}),window.addEventListener("message",function(t){if(t.origin===config.api){var a=t.data;e.ajax({type:"GET",url:config.api+"/profile?access_token="+a,dataType:"json"}).done(function(t){var n="https://graph.facebook.com/"+t.uid+"/picture?width=50";l.emit("add user",{provider:"FB",id:t.id,uid:t.uid,display_name:t.display_name}),moment().format("X")>=moment(config.start_time).format("X")&&moment().format("X")<=moment(config.end_time).format("X")&&e(".add-chat").addClass("show"),e(".login-form").removeClass("show"),e(".logout .avatars").attr("src",n).attr("data-name",t.display_name),e(".logout").addClass("show");var o=parseInt(e(".user-btn .num").text(),10);e(".user-btn .num").text(o+1),e.cookie("live-token",a,{expires:7}),e.cookie("live-fid",t.id,{expires:7}),e.cookie("live-uid",t.uid,{expires:7})}).fail(function(){alert("取得 Facebook 授權失敗。")})}},!1),e(".upload-btn").click(function(t){t.preventDefault(),t.stopImmediatePropagation(),e("#add-photo-file").click()}),e("#add-photo-file").on("change",function(a){a.preventDefault(),a.stopImmediatePropagation();var n=this.files[0]||!1;if(!n)return!1;if(n.size>8388608)return alert("檔案大小必須小於 8MB。"),!1;if(-1===n.type.indexOf("image"))return alert("您必須上傳圖片類型的檔案。"),!1;var o=function(){return alert("上傳照片失敗。"),!1},i=e(this);return i.val(""),e.get(config.api+"/uploadToken?title="+n.name,{},"json").done(function(a){if(!a)return o(),void 0;var i=new FormData;i.append("AWSAccessKeyId","AKIAIE3JKDD3NVIW67BA"),i.append("acl","public-read"),i.append("key",a.key),i.append("policy",a.policy),i.append("success_action_status","201"),i.append("signature",a.signature),i.append("Cache-Control","max-age=1209600"),i.append("Content-Type",a.contentType),i.append("file",n),e.ajax({url:"https://uploads-fanily-tw.s3.amazonaws.com",data:i,type:"POST",dataType:"xml",contentType:!1,processData:!1}).done(function(a){var n=a.getElementsByTagName("Location")[0].firstChild.nodeValue;n=n.replace(/%2F/g,"/");var o=parseInt(e(".comment-btn .num").text(),10);e(".comment-btn .num").text(o+1);var i=t("#template-new-comment",{avatars:e(".logout .avatars").attr("src"),display_name:e(".logout .avatars").attr("data-name"),comment:'<img src="'+n+'">',unixtime:moment().format("X")});if(l.emit("new message",{message:n,isImg:!0}),-1!==e.inArray(e.cookie("live-uid"),config.moderator_uid)){var s=e(i).addClass("announce");0!==e(".comment .announce").length&&e(".comment .announce").remove(),e(".chat-list").before(s),e(".chat-list .mention").removeClass("mention")}e(".chat-list").append(i).animate({scrollTop:e(".chat-list").prop("scrollHeight")},1e3)}).fail(o)}).fail(o),!1})});